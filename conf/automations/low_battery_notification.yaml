# ############################################################
#
#  Create notification for low battery level condition for all battery sensors
#
# ############################################################

# ############################################################
#  Low battery level notification for all battery sensors
# ############################################################
- alias: Low battery level notification for all battery sensors
  id: "b350e9a3-4cfa-4786-a472-7151a7d53891"
  description: "This automation sends a low battery level notification for all battery sensors"
  mode: single
  initial_state: true
  # -------------------- CONDITIONS -------------------
  # if the BLE interface microcontroller is online
  # (actually only important for bluetooth devices by Xiaomi with batteries)
  condition:
    condition: state
    entity_id: binary_sensor.l2_ble01_status
    state:
      - "on"
  # --------------------- BLUEPRINT --------------------
  use_blueprint:
    path: itn3rd77/low-battery-detection-notification.yaml
    # path: sbyx/low-battery-level-detection-notification-for-all-battery-sensors.yaml
    input:
      # execute at given time only
      time: "19:00:00"
      # every day
      # day: 0
      weekday:
        - fri
      #   - mon
      #   - tue
      #   - wed
      #   - thu
      #   - fri
      #   - sat
      #   - sun
      # batteries listed will hold less than threshold percent of capacity
      threshold: 10
      # bullet form for blueprint from itn3rd77
      bullet: "-"
      # --------------------- ACTIONS ---------------------
      # actions:
      #   - service: script.tg_send_txt
      #     data_template:
      #       msg_title: "Low battery level notification"
      #       msg_text: "The following devices have a low bat condition:\n- {{ sensors |replace(',', ',\n-') }}\n"
      #       msg_receiver: "admin"
      actions:
        - service: script.tg_send_txt
          data_template:
            msg_title: "#Low battery level notification#"
            msg_text: "#The following devices have a low bat condition:\n- {{ sensors | replace(',', '\n- ') }}\n#"
            msg_receiver: "admin"
            msg_optional_string: "{{ sensors | replace(',', ',\n-') }}"
            msg_optional_number: "{{ sensors | replace(',', ',\n-') | length }}"
############################################################
#  END OF FILE
# ############################################################
