# ############################################################
#
#  Take care that the ZB plug L2 kitchen dishwasher
#
# ############################################################

# ############################################################
# Zigbee plug turn off after x minutes if power consumption is below x watts
# ############################################################
- alias: ZB plug kitchen dishwasher auto off timer
  id: "edf283ff-f16e-4902-9fbd-bac5b0b1ad29"
  initial_state: false
  # --------------------- TRIGGER ---------------------
  # after the plug was on for x minutes the switch goes off
  trigger:
    # if the ZB plug is on and  it is at least x minutes ago since the power used changed then...
    - platform: template
      value_template:
        "{{ (is_state('switch.zb_plug_l2_kitchen_dishwasher', 'on')) and ((states('sensor.zb_plug_l2_kitchen_dishwasher_power') | float) <= 0.15) and ((now().timestamp() | int) - ((states['sensor.zb_plug_l2_kitchen_dishwasher_power'].last_changed).timestamp() | int ) > (20*60)) }}"
        # (20*60))seconds ==> safety, so that the dishwasher cannot be switched off while it is still working
    # - platform: state
    #   entity_id: switch.zb_plug_l2_kitchen_dishwasher
    #   to: "on"
    #   for:
    #     hours: 4
    #     minutes: 0
  # -------------------- CONDITIONS -------------------
  # if power consumption is below x watts
  condition: []
  # condition:
  #   - condition: template
  #     value_template: '{{ (states("sensor.zb_plug_l2_kitchen_dishwasher_power") | float(0)) < 10 }}'
  # --------------------- ACTIONS ---------------------
  action:
    # ------------------ ZB Plug OFF ------------------
    service: switch.turn_off
    entity_id: switch.zb_plug_l2_kitchen_dishwasher
############################################################
#  END OF FILE
# ############################################################
